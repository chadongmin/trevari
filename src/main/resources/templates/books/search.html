<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë„ì„œ ê²€ìƒ‰</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 30px 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 300;
    }

    .search-container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .search-form {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .search-input {
      flex: 1;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .search-btn {
      padding: 15px 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .search-btn:hover {
      transform: translateY(-2px);
    }

    .search-info {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
    }

    .popular-keywords {
      margin-top: 20px;
    }

    .popular-keywords h3 {
      margin-bottom: 10px;
      color: #333;
    }

    .keyword-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .keyword-tag {
      padding: 6px 12px;
      background: #f0f0f0;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
      text-decoration: none;
      color: #666;
    }

    .keyword-tag:hover {
      background: #e0e0e0;
      color: #333;
    }

    .categories-section {
      margin-top: 20px;
    }

    .categories-section h3 {
      margin-bottom: 10px;
      color: #333;
    }

    .category-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .category-tag {
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 25px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .category-tag:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      color: white;
    }

    .results-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .results-header {
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
    }

    .search-metadata {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .search-query {
      font-weight: 600;
      color: #333;
    }

    .search-stats {
      font-size: 14px;
      color: #666;
    }

    .book-list {
      min-height: 400px;
    }

    .book-item {
      display: flex;
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.3s;
    }

    .book-item:hover {
      background-color: #f8f9fa;
    }

    .book-item:last-child {
      border-bottom: none;
    }

    .book-image {
      width: 80px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin-right: 20px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #999;
    }

    .book-info {
      flex: 1;
    }

    .book-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      line-height: 1.3;
    }

    .book-subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
      font-style: italic;
    }

    .book-meta {
      font-size: 14px;
      color: #777;
      margin-bottom: 4px;
    }

    .book-author {
      font-weight: 500;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      display: none;
    }

    .loading.show {
      display: block;
    }

    .no-results {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      display: none;
    }

    .no-results.show {
      display: block;
    }

    .pagination-info {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 14px;
    }

    /* Rate Limit Alert Styles */
    .rate-limit-alert {
      background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
      display: none;
      animation: slideDown 0.3s ease-out;
    }

    .rate-limit-alert.show {
      display: block;
    }

    .rate-limit-alert h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
    }

    .rate-limit-alert p {
      margin: 0;
      font-size: 14px;
      opacity: 0.9;
    }

    .rate-limit-alert .countdown {
      font-weight: 600;
      color: #ffed4e;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Disabled search button */
    .search-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .search-btn:disabled:hover {
      transform: none;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .search-form {
        flex-direction: column;
      }

      .book-item {
        flex-direction: column;
        text-align: center;
      }

      .book-image {
        margin: 0 auto 15px auto;
      }

      .search-metadata {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ“š ë„ì„œ ê²€ìƒ‰</h1>
    <p>ì›í•˜ëŠ” ë„ì„œë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”</p>
  </div>

  <div class="search-container">
    <!-- Rate Limit Alert -->
    <div class="rate-limit-alert" id="rateLimitAlert">
      <h4>ğŸš« ê²€ìƒ‰ ìš”ì²­ ì œí•œ</h4>
      <p id="rateLimitMessage">ë„ˆë¬´ ë§ì€ ìš”ì²­ìœ¼ë¡œ ì¸í•´ ì¼ì‹œì ìœ¼ë¡œ ê²€ìƒ‰ì´ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      <p>ë‹¤ì‹œ ì‹œë„í•  ìˆ˜ ìˆëŠ” ì‹œê°„: <span class="countdown" id="retryCountdown">--</span></p>
    </div>

    <form class="search-form" id="searchForm">
      <input type="text"
             class="search-input"
             id="searchInput"
             placeholder="ë„ì„œ ì œëª©, ì €ì, ì¶œíŒì‚¬ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”..."
             th:value="${searchQuery}"
             autocomplete="off">
      <button type="submit" class="search-btn" id="searchBtn">ê²€ìƒ‰</button>
    </form>

    <div class="search-info">
      <p>ğŸ’¡ ê²€ìƒ‰ íŒ: '|' ë¡œ OR ê²€ìƒ‰, '-'ë¡œ NOT ê²€ìƒ‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ì˜ˆ: "ìë°”|íŒŒì´ì¬", "í”„ë¡œê·¸ë˜ë°-ì…ë¬¸")</p>
    </div>

    <div class="popular-keywords" id="popularKeywords">
      <h3>ğŸ”¥ ì¸ê¸° ê²€ìƒ‰ì–´</h3>
      <div class="keyword-tags" id="keywordTags">
        <!-- ì¸ê¸° ê²€ìƒ‰ì–´ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
      </div>
    </div>

    <div class="categories-section" id="categoriesSection">
      <h3>ğŸ“‚ ì¹´í…Œê³ ë¦¬ë³„ ë„ì„œ</h3>
      <div class="category-tags" id="categoryTags">
        <!-- ì¹´í…Œê³ ë¦¬ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
      </div>
    </div>
  </div>

  <div class="results-container" id="resultsContainer" style="display: none;">
    <div class="results-header">
      <div class="search-metadata">
        <div class="search-query" id="displaySearchQuery"></div>
        <div class="search-stats" id="searchStats"></div>
      </div>
    </div>

    <div class="book-list" id="bookList">
      <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>

    <div class="loading" id="loading">
      <p>ğŸ“– ë„ì„œë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
    </div>

    <div class="no-results" id="noResults">
      <h3>ğŸ˜• ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
      <p>ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
    </div>

    <div class="pagination-info" id="paginationInfo"></div>
  </div>
</div>

<script>
  class BookSearch {
    constructor() {
      this.currentPage = 1;
      this.hasMore = true;
      this.loading = false;
      this.searchQuery = '';
      this.categoryQuery = '';
      this.isShowingAllBooks = false;
      this.rateLimitUntil = 0;
      this.countdownInterval = null;

      this.initializeElements();
      this.bindEvents();
      this.loadPopularKeywords();
      this.loadCategories();
      this.loadAllBooks(); // í˜ì´ì§€ ë¡œë”© ì‹œ ì „ì²´ ëª©ë¡ í‘œì‹œ
    }

    initializeElements() {
      this.searchForm = document.getElementById('searchForm');
      this.searchInput = document.getElementById('searchInput');
      this.searchBtn = document.getElementById('searchBtn');
      this.resultsContainer = document.getElementById('resultsContainer');
      this.bookList = document.getElementById('bookList');
      this.loadingElement = document.getElementById('loading');
      this.noResultsElement = document.getElementById('noResults');
      this.displaySearchQuery = document.getElementById('displaySearchQuery');
      this.searchStats = document.getElementById('searchStats');
      this.paginationInfo = document.getElementById('paginationInfo');
      this.keywordTags = document.getElementById('keywordTags');
      this.categoryTags = document.getElementById('categoryTags');
      this.rateLimitAlert = document.getElementById('rateLimitAlert');
      this.rateLimitMessage = document.getElementById('rateLimitMessage');
      this.retryCountdown = document.getElementById('retryCountdown');
    }

    bindEvents() {
      this.searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        this.performSearch();
      });

      // ë¬´í•œ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸
      window.addEventListener('scroll', () => {
        if (this.shouldLoadMore()) {
          this.loadMore();
        }
      });

      // Enter í‚¤ëŠ” í¼ ì œì¶œë¡œ ìë™ ì²˜ë¦¬ë©ë‹ˆë‹¤
    }

    shouldLoadMore() {
      if (this.loading || !this.hasMore) {
        return false;
      }

      // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆê±°ë‚˜ ì „ì²´ ëª©ë¡ì„ ë³´ê³  ìˆì„ ë•Œë§Œ ë¬´í•œ ìŠ¤í¬ë¡¤ í™œì„±í™”
      if (!this.searchQuery && !this.isShowingAllBooks) {
        return false;
      }

      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;

      return scrollTop + windowHeight >= documentHeight - 1000;
    }

    async performSearch(resetResults = true) {
      const query = this.searchInput.value.trim();

      if (!query) {
        alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // Rate limit ì²´í¬
      if (this.isRateLimited()) {
        return;
      }

      if (resetResults) {
        this.currentPage = 1;
        this.hasMore = true;
        this.searchQuery = query;
        this.isShowingAllBooks = false;
        this.bookList.innerHTML = '';
        this.hideNoResults();
      }

      this.showLoading();

      try {
        const response = await fetch(
            `/api/search/books?keyword=${encodeURIComponent(query)}&page=${this.currentPage}&size=20`);

        if (response.status === 429) {
          const data = await response.json();
          this.handleRateLimit(data);
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          this.hideRateLimitAlert();
          this.handleSearchResults(data.data, resetResults);
        } else {
          throw new Error(data.message || 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('Search error:', error);
        if (error.message.includes('429')) {
          // 429 ì—ëŸ¬ëŠ” ì´ë¯¸ ì²˜ë¦¬ë¨
          return;
        }
        alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      } finally {
        this.hideLoading();
      }
    }

    async loadAllBooks(resetResults = true) {
      if (resetResults) {
        this.currentPage = 1;
        this.hasMore = true;
        this.searchQuery = '';
        this.isShowingAllBooks = true;
        this.bookList.innerHTML = '';
        this.hideNoResults();
      }

      this.showLoading();

      try {
        const response = await fetch(`/api/books/all?page=${this.currentPage}&size=20`);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          this.handleAllBooksResults(data.data, resetResults);
        } else {
          throw new Error(data.message || 'ë„ì„œ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('Load all books error:', error);
        console.log('ë„ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error.message);
      } finally {
        this.hideLoading();
      }
    }

    handleSearchResults(data, resetResults) {
      const {books, pageInfo, searchMetadata, searchQuery} = data;

      if (resetResults) {
        this.displaySearchQuery.textContent = `"${searchQuery}" ê²€ìƒ‰ ê²°ê³¼`;
        this.updateSearchStats(pageInfo, searchMetadata);
        this.resultsContainer.style.display = 'block';
      }

      if (books && books.length > 0) {
        this.appendBooks(books);
        this.currentPage++;
        this.hasMore = this.currentPage <= pageInfo.totalPages;
        this.updatePaginationInfo(pageInfo);
      } else if (resetResults) {
        this.showNoResults();
      }
    }

    handleAllBooksResults(data, resetResults) {
      const {books, pageInfo, searchMetadata} = data;

      if (resetResults) {
        this.displaySearchQuery.textContent = 'ğŸ“š ì „ì²´ ë„ì„œ ëª©ë¡';
        this.updateAllBooksStats(pageInfo, searchMetadata);
        this.resultsContainer.style.display = 'block';
      }

      if (books && books.length > 0) {
        this.appendBooks(books);
        this.currentPage++;
        this.hasMore = this.currentPage <= pageInfo.totalPages;
        this.updatePaginationInfo(pageInfo);
      } else if (resetResults) {
        this.showNoResults();
      }
    }

    appendBooks(books) {
      books.forEach(book => {
        const bookElement = this.createBookElement(book);
        this.bookList.appendChild(bookElement);
      });
    }

    createBookElement(book) {
      const bookDiv = document.createElement('div');
      bookDiv.className = 'book-item';

      // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ - ë„ì„œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
      bookDiv.style.cursor = 'pointer';
      bookDiv.addEventListener('click', () => {
        window.location.href = `/books/${encodeURIComponent(book.isbn)}`;
      });

      const imageUrl = book.imageUrl || 'https://via.placeholder.com/80x120/f0f0f0/999999?text=NO+IMAGE';
      const authors = Array.isArray(book.authors) ? book.authors.join(', ') : (book.author || 'ì €ì ë¯¸ìƒ');

      bookDiv.innerHTML = `
                    <div class="book-image">
                        <img src="${imageUrl}" alt="${this.escapeHtml(book.title)}" 
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/80x120/f0f0f0/999999?text=ğŸ“–';"
                             style="width: 80px; height: 120px; object-fit: cover;">
                    </div>
                    <div class="book-info">
                        <div class="book-title">${this.escapeHtml(book.title)}</div>
                        ${book.subtitle ? `<div class="book-subtitle">${this.escapeHtml(book.subtitle)}</div>` : ''}
                        <div class="book-meta">
                            <span class="book-author">ì €ì: ${this.escapeHtml(authors)}</span>
                        </div>
                        <div class="book-meta">ì¶œíŒì‚¬: ${this.escapeHtml(book.publisher)}</div>
                        <div class="book-meta">ì¶œê°„ì¼: ${book.publishedDate}</div>
                        <div class="book-meta">ISBN: ${book.isbn}</div>
                    </div>
                `;

      return bookDiv;
    }

    updateSearchStats(pageInfo, searchMetadata) {
      const strategy = this.getStrategyText(searchMetadata.strategy);
      this.searchStats.innerHTML = `
                    ì´ ${pageInfo.totalElements}ê¶Œ ê²€ìƒ‰ 
                    (${searchMetadata.executionTimeMs}ms, ${strategy})
                `;
    }

    updateAllBooksStats(pageInfo, searchMetadata) {
      this.searchStats.innerHTML = `
                    ì´ ${pageInfo.totalElements}ê¶Œì˜ ë„ì„œ 
                    (${searchMetadata.executionTimeMs}ms)
                `;
    }

    getStrategyText(strategy) {
      const strategyMap = {
        'SIMPLE': 'ê¸°ë³¸ ê²€ìƒ‰',
        'OR_OPERATION': 'OR ê²€ìƒ‰',
        'NOT_OPERATION': 'NOT ê²€ìƒ‰',
        'ALL': 'ì „ì²´ ì¡°íšŒ'
      };
      return strategyMap[strategy] || strategy;
    }

    updatePaginationInfo(pageInfo) {
      this.paginationInfo.textContent =
          `${pageInfo.currentPage} / ${pageInfo.totalPages} í˜ì´ì§€`;
    }

    async loadMore() {
      if (this.loading || !this.hasMore) {
        return;
      }

      this.loading = true;

      if (this.isShowingAllBooks) {
        await this.loadAllBooks(false);
      } else if (this.categoryQuery) {
        await this.searchByCategory(this.categoryQuery, false);
      } else {
        await this.performSearch(false);
      }

      this.loading = false;
    }

    async loadPopularKeywords() {
      try {
        const response = await fetch('/api/search/popular');

        if (response.status === 429) {
          const data = await response.json();
          this.handleRateLimit(data, false); // ì¸ê¸° ê²€ìƒ‰ì–´ëŠ” UI ë¹„í™œì„±í™” ì•ˆí•¨
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success && data.data.keywords) {
          this.displayPopularKeywords(data.data.keywords);
        }
      } catch (error) {
        console.error('ì¸ê¸° ê²€ìƒ‰ì–´ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    async loadCategories() {
      try {
        // ì¸ê¸° ì¹´í…Œê³ ë¦¬ (ì±… ìˆ˜ê°€ ë§ì€ ìˆœ) ë¡œë“œ
        const response = await fetch('/api/categories/popular?limit=15');

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success && data.data) {
          this.displayCategories(data.data);
        }
      } catch (error) {
        console.error('ì¸ê¸° ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
        // ì‹¤íŒ¨ì‹œ ì „ì²´ ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹œë„
        try {
          const fallbackResponse = await fetch('/api/categories');
          const fallbackData = await fallbackResponse.json();
          if (fallbackData.success && fallbackData.data) {
            this.displayCategories(fallbackData.data.slice(0, 15));
          }
        } catch (fallbackError) {
          console.error('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì™„ì „ ì‹¤íŒ¨:', fallbackError);
        }
      }
    }

    async searchByCategory(categoryName, resetResults = true) {
      if (resetResults) {
        this.currentPage = 1;
        this.hasMore = true;
        this.searchQuery = '';
        this.isShowingAllBooks = false;
        this.categoryQuery = categoryName;
        this.bookList.innerHTML = '';
        this.hideNoResults();
      }

      this.showLoading();

      try {
        const response = await fetch(
            `/api/books/category/${encodeURIComponent(categoryName)}?page=${this.currentPage}&size=20`);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          this.handleCategoryResults(data.data, resetResults, categoryName);
        } else {
          throw new Error(data.message || 'ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('Category search error:', error);
        alert('ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      } finally {
        this.hideLoading();
      }
    }

    displayPopularKeywords(keywords) {
      this.keywordTags.innerHTML = '';

      keywords.slice(0, 10).forEach(keyword => {
        const tag = document.createElement('a');
        tag.className = 'keyword-tag';
        tag.href = '#';
        tag.textContent = `${keyword.keyword} (${keyword.searchCount})`;
        tag.addEventListener('click', (e) => {
          e.preventDefault();
          this.searchInput.value = keyword.keyword;
          this.performSearch();
        });
        this.keywordTags.appendChild(tag);
      });
    }

    displayCategories(categories) {
      this.categoryTags.innerHTML = '';

      categories.forEach(category => {
        const tag = document.createElement('button');
        tag.className = 'category-tag';
        // ì±… ìˆ˜ê°€ ìˆìœ¼ë©´ í‘œì‹œ, ì—†ìœ¼ë©´ ì¹´í…Œê³ ë¦¬ëª…ë§Œ í‘œì‹œ
        tag.textContent = category.bookCount ?
            `${category.name} (${category.bookCount})` :
            category.name;
        tag.addEventListener('click', (e) => {
          e.preventDefault();
          this.searchByCategory(category.name);
        });
        this.categoryTags.appendChild(tag);
      });
    }

    handleCategoryResults(data, resetResults, categoryName) {
      const {books, pageInfo, searchMetadata} = data;

      if (resetResults) {
        this.displaySearchQuery.textContent = `ğŸ“‚ "${categoryName}" ì¹´í…Œê³ ë¦¬ ë„ì„œ`;
        this.updateCategoryStats(pageInfo, searchMetadata, categoryName);
        this.resultsContainer.style.display = 'block';
      }

      if (books && books.length > 0) {
        this.appendBooks(books);
        this.currentPage++;
        this.hasMore = this.currentPage <= pageInfo.totalPages;
        this.updatePaginationInfo(pageInfo);
      } else if (resetResults) {
        this.showNoResults();
      }
    }

    updateCategoryStats(pageInfo, searchMetadata, categoryName) {
      this.searchStats.innerHTML = `
                    "${categoryName}" ì¹´í…Œê³ ë¦¬ ì´ ${pageInfo.totalElements}ê¶Œ
                    (${searchMetadata.executionTimeMs}ms)
                `;
    }

    showLoading() {
      this.loading = true;
      this.loadingElement.classList.add('show');
    }

    hideLoading() {
      this.loading = false;
      this.loadingElement.classList.remove('show');
    }

    showNoResults() {
      this.noResultsElement.classList.add('show');
    }

    hideNoResults() {
      this.noResultsElement.classList.remove('show');
    }

    escapeHtml(text) {
      if (!text) {
        return '';
      }
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Rate Limit ê´€ë ¨ ë©”ì„œë“œë“¤
    isRateLimited() {
      return Date.now() < this.rateLimitUntil;
    }

    handleRateLimit(errorData, disableUI = true) {
      console.log('Rate limit response:', errorData);
      
      // ì—ëŸ¬ ë©”ì‹œì§€ì—ì„œ ì¬ì‹œë„ ì‹œê°„ ì¶”ì¶œ
      let retrySeconds = 10; // ê¸°ë³¸ê°’
      if (errorData.data && errorData.data.length > 0) {
        const message = errorData.data[0].message;
        const match = message.match(/(\d+)\s*seconds?/);
        if (match) {
          retrySeconds = parseInt(match[1]);
        }
      }

      this.rateLimitUntil = Date.now() + (retrySeconds * 1000);
      this.showRateLimitAlert(errorData.data[0].message, retrySeconds, disableUI);
    }

    showRateLimitAlert(message, retrySeconds, disableUI = true) {
      this.rateLimitMessage.textContent = message;
      this.rateLimitAlert.classList.add('show');
      
      if (disableUI) {
        this.searchBtn.disabled = true;
        this.searchInput.disabled = true;
      }

      this.startCountdown(retrySeconds, disableUI);
    }

    hideRateLimitAlert() {
      this.rateLimitAlert.classList.remove('show');
      this.searchBtn.disabled = false;
      this.searchInput.disabled = false;
      
      if (this.countdownInterval) {
        clearInterval(this.countdownInterval);
        this.countdownInterval = null;
      }
    }

    startCountdown(seconds, disableUI = true) {
      if (this.countdownInterval) {
        clearInterval(this.countdownInterval);
      }

      let remaining = seconds;
      this.updateCountdown(remaining);

      this.countdownInterval = setInterval(() => {
        remaining--;
        this.updateCountdown(remaining);

        if (remaining <= 0) {
          clearInterval(this.countdownInterval);
          this.countdownInterval = null;
          this.hideRateLimitAlert();
        }
      }, 1000);
    }

    updateCountdown(seconds) {
      if (seconds <= 0) {
        this.retryCountdown.textContent = '0ì´ˆ';
        return;
      }

      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      
      if (minutes > 0) {
        this.retryCountdown.textContent = `${minutes}ë¶„ ${remainingSeconds}ì´ˆ`;
      } else {
        this.retryCountdown.textContent = `${remainingSeconds}ì´ˆ`;
      }
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', () => {
    new BookSearch();
  });
</script>
</body>
</html>